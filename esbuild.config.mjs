// esbuild.config.mjs
import esbuild from "esbuild";
import process from "process";
import builtins from "builtin-modules";
import vue from "unplugin-vue/esbuild";
import { promises as fs } from "fs";

const banner =
`/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
`;

const prod = (process.argv[2] === "production");

const copyToStylesPlugin = {
  name: "copy-vue-css-to-styles",
  setup(build) {
    build.onEnd(async () => {
      try {
        await fs.copyFile("main.css", "styles.css");
      } catch { /* ignore if no CSS yet */ }
    });
  }
};

const yamlLoaderPlugin = {
  name: "yaml-loader",
  setup(build) {
    build.onLoad({ filter: /\.ya?ml$/ }, async (args) => {
      try {
        const text = await fs.readFile(args.path, 'utf8');
        // Parse YAML to JavaScript object
        // Simple YAML-to-JSON parser for basic YAML structures
        const yamlToJson = (yaml) => {
          const lines = yaml.split('\n');
          const result = {};
          const stack = [{ obj: result, indent: -1 }];
          
          for (const line of lines) {
            if (line.trim() === '' || line.trim().startsWith('#')) continue;
            
            const indent = line.search(/\S/);
            const trimmed = line.trim();
            
            // Handle key-value pairs
            const match = trimmed.match(/^([^:]+):\s*(.*)$/);
            if (match) {
              const [, key, value] = match;
              const cleanKey = key.trim();
              let parsedValue = value.trim();
              
              // Remove quotes
              if (parsedValue.startsWith('"') && parsedValue.endsWith('"')) {
                parsedValue = parsedValue.slice(1, -1);
              }
              
              // Parse boolean/null
              if (parsedValue === 'true') parsedValue = true;
              else if (parsedValue === 'false') parsedValue = false;
              else if (parsedValue === 'null') parsedValue = null;
              else if (parsedValue === '') parsedValue = {};
              
              // Adjust stack based on indentation
              while (stack.length > 1 && indent <= stack[stack.length - 1].indent) {
                stack.pop();
              }
              
              const current = stack[stack.length - 1].obj;
              current[cleanKey] = parsedValue;
              
              // If value is empty or object, push to stack for nested properties
              if (typeof parsedValue === 'object') {
                stack.push({ obj: parsedValue, indent });
              }
            }
          }
          
          return result;
        };
        
        const parsed = yamlToJson(text);
        return {
          contents: `export default ${JSON.stringify(parsed)};`,
          loader: 'js',
        };
      } catch (error) {
        return {
          errors: [{
            text: `Failed to load YAML file: ${error.message}`,
            location: { file: args.path }
          }]
        };
      }
    });
  }
};

const context = await esbuild.context({
  banner: { js: banner },
  entryPoints: ["main.ts"],
  bundle: true,
  external: [
    "obsidian",
    "electron",
    "@codemirror/autocomplete",
    "@codemirror/collab",
    "@codemirror/commands",
    "@codemirror/language",
    "@codemirror/lint",
    "@codemirror/search",
    "@codemirror/state",
    "@codemirror/view",
    "@lezer/common",
    "@lezer/highlight",
    "@lezer/lr",
    ...builtins
  ],
  format: "cjs",
  target: "es2018",
  logLevel: "info",
  sourcemap: prod ? false : true,
  treeShaking: true,
  outfile: "main.js",
  tsconfig: "tsconfig.json",
  minify: prod,
  plugins: [
    vue({ sourceMap: false }),
	copyToStylesPlugin,
	yamlLoaderPlugin
  ],
  define: {
    'process.env.NODE_ENV': JSON.stringify(prod ? 'production' : 'development'),
    __VUE_OPTIONS_API__: 'false',                     // no options api, composition api is preferred
    __VUE_PROD_DEVTOOLS__: 'false',                   // no devtools in production
    __VUE_PROD_HYDRATION_MISMATCH_DETAILS__: 'false'  // no extra hydration info
  }
});

if (prod) {
  await context.rebuild();
  process.exit(0);
} else {
  await context.watch();
}
